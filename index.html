<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Flow Sankey Diagram</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
        }

        .link {
            fill: none;
            stroke-opacity: 0.5;
        }

        .link:hover {
            stroke-opacity: 0.8;
        }

        .node text {
            pointer-events: none;
        }

        .sankey-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font-size: 14px;
            background: #1f2937;
            color: #ffffff;
            border: 0;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Flip card styles */
        .flip-card {
            perspective: 1000px;
        }

        .dashboard-panel {
            min-height: 300px;
            /* Ensures consistent height */
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            /* Match parent */
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        .validation-tooltip {
            position: absolute;
            background-color: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-gray-50">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Material flow analysis</h1>

            <p class="text-gray-600 mb-4">
                This interactive tool is designed for Material Flow Analysis (MFA) of a manufacturing process that uses
                both virgin and recycled materials. It helps visualize how different factors influence material
                efficiency, waste generation, and the potential for a circular economy.
            </p>
            <div class="text-gray-600 mb-6 text-sm p-4 bg-gray-50 rounded-lg border">
                <h3 class="font-semibold text-base text-gray-700 mb-2">How to use this tool</h3>
                <ol class="list-decimal list-inside space-y-1">
                    <li><strong>Set initial mass:</strong> Start by entering the total mass and unit for your system.
                    </li>
                    <li><strong>Choose your mode:</strong> Use the "Simulation mode" (sliders) to predict outcomes, or
                        flip to the "Experiment log" to calculate efficiencies from measured weights.</li>
                    <li><strong>Analyze results:</strong> The panels below the diagram show the required inputs and the
                        final system yield.</li>
                    <li><strong>Explore the flow:</strong> The diagram displays values in your chosen unit. Hover over
                        any flow or process box for precise values.</li>
                </ol>
            </div>

            <!-- Top Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Initial Mass Input -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg lg:col-span-1 dashboard-panel">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Initial input mass</label>
                    <p class="text-xs text-gray-500 mb-4">Define the starting mass and unit for the simulation.</p>
                    <div class="flex items-center space-x-4">
                        <div class="flex-grow">
                            <label for="totalMass" class="text-xs text-gray-600">Mass</label>
                            <input type="number" id="totalMass" value="100.0" step="0.1" min="0"
                                class="w-full mt-1 p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="w-1/3">
                            <label for="massUnit" class="text-xs text-gray-600">Unit</label>
                            <input type="text" id="massUnit" value="g"
                                class="w-full mt-1 p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Process Parameters / Experiment Log -->
                <div class="lg:col-span-2 flip-card dashboard-panel" id="parameter-card">
                    <div class="flip-card-inner">
                        <!-- Front: Sliders -->
                        <div class="p-4 bg-blue-50 border border-blue-200 flip-card-front flex flex-col">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 font-bold">Simulation
                                        mode</label>
                                    <p class="text-xs text-gray-500">Adjust sliders to predict outcomes.</p>
                                </div>
                                <button id="flip-to-log" class="p-2 rounded-full hover:bg-blue-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                        class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                        <path
                                            d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                                        <path fill-rule="evenodd"
                                            d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A4.5 4.5 0 0 0 8 3zM3.5 9A4.5 4.5 0 0 0 8 13c1.552 0-2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-8 mt-4 flex-grow flex flex-col justify-center">
                                <div>
                                    <label for="successRate" class="block text-sm font-medium text-gray-700">Part
                                        success rate (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="successRate" min="0" max="100" value="80" step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="successRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">80.0%</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="printLossRate" class="block text-sm font-medium text-gray-700">Print
                                        loss (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="printLossRate" min="0" max="100" value="10" step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="printLossRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">10.0%</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="recyclingLossRate"
                                        class="block text-sm font-medium text-gray-700">Recycling loss (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="recyclingLossRate" min="0" max="100" value="10"
                                            step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="recyclingLossRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">10.0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Back: Experiment Log -->
                        <div class="p-4 bg-blue-50 border border-blue-200 flip-card-back flex flex-col">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 font-bold">Experiment
                                        log</label>
                                    <p class="text-xs text-gray-500">Enter measured weights to calculate efficiencies.
                                    </p>
                                </div>
                                <button id="flip-to-sim" class="p-2 rounded-full hover:bg-blue-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                        class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                        <path
                                            d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                                        <path fill-rule="evenodd"
                                            d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A4.5 4.5 0 0 0 8 3zM3.5 9A4.5 4.5 0 0 0 8 13c1.552 0-2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-4 flex-grow flex flex-col justify-center">
                                <!-- Top Row: Inputs -->
                                <div class="flex items-start justify-around space-x-4">
                                    <!-- Step 1 -->
                                    <div id="exp-step-1" class="flex-1 relative">
                                        <div class="p-2 rounded-t-md" style="background-color: #dae8fc;">
                                            <label for="printedActuatorMass"
                                                class="block text-xs font-medium text-gray-700">Printed actuator
                                                mass</label>
                                        </div>
                                        <input type="number" id="printedActuatorMass" placeholder="e.g., 90.0"
                                            step="0.1" min="0"
                                            class="w-full p-2 text-sm border-t-0 border rounded-b-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="text-gray-400 pt-8">&nbsp;</div>
                                    <!-- Step 2 -->
                                    <div id="exp-step-2" class="flex-1 relative hidden">
                                        <div class="p-2 rounded-t-md" style="background-color: #e6f7ff;">
                                            <label for="successfulProductMass"
                                                class="block text-xs font-medium text-gray-700">Successful product
                                                mass</label>
                                        </div>
                                        <input type="number" id="successfulProductMass" placeholder="e.g., 72.0"
                                            step="0.1" min="0"
                                            class="w-full p-2 text-sm border-t-0 border rounded-b-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="text-gray-400 pt-8">&nbsp;</div>
                                    <!-- Step 3 -->
                                    <div id="exp-step-3" class="flex-1 relative hidden">
                                        <div class="p-2 rounded-t-md" style="background-color: #dcfce7;">
                                            <label for="recycledPelletsOutputMass"
                                                class="block text-xs font-medium text-gray-700">Recycled pellets
                                                mass</label>
                                        </div>
                                        <input type="number" id="recycledPelletsOutputMass" placeholder="e.g., 16.2"
                                            step="0.1" min="0"
                                            class="w-full p-2 text-sm border-t-0 border rounded-b-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>
                                <!-- Bottom Row: Calculations -->
                                <div class="flex items-start justify-around space-x-4">
                                    <div id="calc-step-1" class="flex-1 text-center hidden">
                                        <div class="flex items-center justify-center text-gray-400 text-2xl">
                                            <span class="mr-2">↳</span>
                                            <div
                                                class="p-2 rounded-md text-xs bg-gray-200 border border-gray-300 flex-grow">
                                                <div class="font-bold">Print loss</div>
                                                <div id="calc-print-loss"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="calc-step-2" class="flex-1 text-center hidden">
                                        <div class="flex items-center justify-center text-gray-400 text-2xl">
                                            <span class="mr-2">↳</span>
                                            <div class="p-2 rounded-md text-xs flex-grow"
                                                style="background-color: #ffe6cc; border: 1px solid #fed7aa;">
                                                <div class="font-bold">Failed parts</div>
                                                <div id="calc-failed-parts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="calc-step-3" class="flex-1 text-center hidden">
                                        <div class="flex items-center justify-center text-gray-400 text-2xl">
                                            <span class="mr-2">↳</span>
                                            <div
                                                class="p-2 rounded-md text-xs bg-gray-200 border border-gray-300 flex-grow">
                                                <div class="font-bold">Recycling loss</div>
                                                <div id="calc-recycling-loss"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="log-run-container" class="text-center hidden">
                                    <button id="log-run-btn"
                                        class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Log
                                        this Run</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sankey-chart-container" class="w-full overflow-x-auto mt-6 mb-6">
                <svg id="sankey"></svg>
            </div>

            <!-- Experiment Data Table -->
            <div id="experiment-data-panel" class="hidden">
                <div class="p-4 bg-gray-100 border border-gray-200 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700 font-bold">Experiment data</label>
                        <div>
                            <button id="clear-runs-btn" class="text-xs text-red-600 hover:underline">Clear All</button>
                            <button id="toggle-data-panel" class="ml-2 p-1 rounded-full hover:bg-gray-200">
                                <svg id="collapse-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    fill="currentColor" class="bi bi-chevron-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="data-table-content">
                        <p class="text-xs text-gray-500 mb-4">
                            Logged runs for initial mass of <span id="log-initial-mass" class="font-semibold"></span>.
                        </p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">Printed Actuator</th>
                                        <th class="p-2">Successful Product</th>
                                        <th class="p-2">Recycled Pellets</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="experiment-runs-body">
                                </tbody>
                                <tfoot id="experiment-avg-footer" class="bg-gray-200 font-bold">
                                </tfoot>
                            </table>
                        </div>
                        <div id="apply-avg-container" class="text-center mt-4 hidden">
                            <div class="flex justify-center items-center space-x-4">
                                <button id="apply-avg-btn"
                                    class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Apply
                                    Averages to Simulation</button>
                                <button id="export-csv-btn"
                                    class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Export
                                    to CSV</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Dashboard -->
            <div id="results-dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Material Composition Display -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Required input
                        composition</label>
                    <p class="text-xs text-gray-500 mb-4">The calculated material mix needed to sustain the process
                        based on losses.</p>
                    <div class="flex items-center space-x-4 text-center">
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Virgin material</div>
                            <div id="virginRateDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Recycled pellets</div>
                            <div id="recycledRateDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Overall System Yield Display -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Overall system yield</label>
                    <p class="text-xs text-gray-500 mb-4">The final percentage of material that becomes successful
                        product vs. total loss.</p>
                    <div class="flex items-center space-x-4 text-center">
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Successful product</div>
                            <div id="yieldDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Total system loss</div>
                            <div id="lossDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sankey-tooltip"></div>
        </div>
    </div>

    <!-- Modal for Edge Case Explanations -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Edge Case Detected</h3>
            <p id="modal-text" class="text-gray-600 mb-5">Explanation of the scenario.</p>
            <button id="modal-close"
                class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Close</button>
        </div>
    </div>

    <script>
        // --- Data Processing and Initial Setup ---
        const graphData = {
            nodes: [
                { name: "Virgin material", color: "#647687" },
                { name: "Recycled pellets|(input)", color: "#22c55e" },
                { name: "Print process", color: "#f8cecc" },
                { name: "Printed actuator", color: "#dae8fc" },
                { name: "Successful product", color: "#e6f7ff" },
                { name: "Failed parts", color: "#ffe6cc" },
                { name: "Shredder", color: "#76608a" },
                { name: "Print loss", color: "#d6d6d6" },
                { name: "Recycling loss", color: "#d6d6d6" },
                { name: "Recycled pellets|(output)", color: "#22c55e" }
            ],
            links: [] // Links are calculated dynamically
        };

        // --- D3 Sankey Drawing Function ---
        function drawSankey(data, totalMass, massUnit) {
            const container = d3.select("#sankey-chart-container");
            container.select("svg").selectAll("*").remove();

            const containerWidth = parseInt(container.style("width"));
            const height = 500;
            const width = Math.max(containerWidth, 900);

            const svg = d3.select("#sankey")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMinYMin meet");

            // --- Dynamic Node Width Calculation ---
            let maxTextWidth = 0;
            const tempText = svg.append("text")
                .attr("font-family", "Inter, sans-serif")
                .attr("font-size", "12px")
                .attr("font-weight", "bold");

            data.nodes.forEach(node => {
                if (node.value > 0.01) {
                    const text = `${node.value.toFixed(1)} ${massUnit}`;
                    maxTextWidth = Math.max(maxTextWidth, tempText.text(text).node().getComputedTextLength());
                }
            });
            tempText.remove();
            const dynamicNodeWidth = Math.max(60, maxTextWidth + 10);

            const sankey = d3.sankey()
                .nodeId(d => d.name)
                .nodeWidth(dynamicNodeWidth)
                .nodePadding(20)
                .nodeAlign(d3.sankeyJustify)
                .extent([[1, 5], [width - 1, height - 10]]);

            let layout;
            try {
                layout = sankey(data);
            } catch (error) {
                console.error("Error computing Sankey layout:", error);
                container.html(`<div class="text-red-600 p-4">Error: Could not generate the diagram.</div>`);
                return;
            }
            const { nodes, links } = layout;
            const tooltip = d3.select(".sankey-tooltip");

            // Draw Links
            const linkGroup = svg.append("g").attr("fill", "none").attr("stroke-opacity", 0.5);
            const link = linkGroup.selectAll("g").data(links).join("g").style("mix-blend-mode", "multiply");
            const gradient = link.append("linearGradient")
                .attr("id", (d, i) => `gradient-${i}`)
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", d => d.source.x1)
                .attr("x2", d => d.target.x0);
            gradient.append("stop").attr("offset", "0%").attr("stop-color", d => d.source.color);
            gradient.append("stop").attr("offset", "100%").attr("stop-color", d => d.target.color);
            link.append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width));

            link.on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${d.source.name.replace('|', ' ')} &rarr; ${d.target.name.replace('|', ' ')}<br><b>${d.value.toFixed(2)} ${massUnit}</b>`)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Draw Nodes
            const nodeGroup = svg.append("g").attr("class", "nodes");
            const node = nodeGroup.selectAll("g").data(nodes).join("g")
                .style("display", d => d.value < 0.01 ? "none" : "block");

            node.append("rect")
                .attr("x", d => d.x0).attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
                .attr("fill", d => d.color).attr("stroke", "#374151")
                .attr("stroke-width", 1.5).attr("rx", 4).attr("ry", 4);

            node.on("mouseover", (event, d) => {
                const percentage = totalMass > 0 ? (d.value / totalMass * 100).toFixed(1) : 0;
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${d.name.replace('|', ' ')}<br><b>${d.value.toFixed(1)} ${massUnit}</b><br><span class="text-xs">(${percentage}% of total)</span>`)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Add Node Labels (Name)
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .style("font-size", "13px")
                .style("font-weight", "600")
                .style("fill", "#374151")
                .each(function (d) {
                    const lines = d.name.split('|');
                    const textElement = d3.select(this);
                    const lineHeight = 1.2;
                    const startDy = -((lines.length - 1) / 2) * lineHeight;

                    lines.forEach((line, i) => {
                        textElement.append("tspan")
                            .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                            .attr("dy", i === 0 ? `${startDy}em` : `${lineHeight}em`)
                            .text(line);
                    });
                });

            // Add Node Value inside the box
            node.append("text")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => `${d.value.toFixed(1)} ${massUnit}`)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("fill", "#111827")
                .style("display", d => (d.y1 - d.y0) > 15 ? "block" : "none");

        }

        // --- Dynamic Calculation Function for Steady-State ---
        function calculateAndDraw(params) {
            const { successRate, printLossRate, recyclingLossRate, totalMass, massUnit } = params;

            const successDecimal = successRate / 100;
            const printLossDecimal = printLossRate / 100;
            const recyclingLossDecimal = recyclingLossRate / 100;

            const printLoss = totalMass * printLossDecimal;
            const toPart = totalMass * (1 - printLossDecimal);

            const successfulParts = toPart * successDecimal;
            const failedParts = toPart * (1 - successDecimal);

            const recyclingLoss = failedParts * recyclingLossDecimal;
            const recycledPelletsOutput = failedParts * (1 - recyclingLossDecimal);

            const recycledInput = recycledPelletsOutput;
            const virginInput = printLoss + recyclingLoss + successfulParts;
            const totalLoss = printLoss + recyclingLoss + (failedParts * (1 - (1 - recyclingLossDecimal)))

            // Update display boxes
            const virginPercent = totalMass > 0 ? (virginInput / totalMass * 100).toFixed(1) : 0;
            const recycledPercent = totalMass > 0 ? (recycledInput / totalMass * 100).toFixed(1) : 0;
            document.getElementById('virginRateDisplay').innerHTML = `${virginInput.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${virginPercent}%)</span>`;
            document.getElementById('recycledRateDisplay').innerHTML = `${recycledInput.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${recycledPercent}%)</span>`;

            const yieldPercent = totalMass > 0 ? (successfulParts / totalMass * 100).toFixed(1) : 0;
            const totalLossMass = totalMass - successfulParts;
            const lossPercent = totalMass > 0 ? (totalLossMass / totalMass * 100).toFixed(1) : 0;
            document.getElementById('yieldDisplay').innerHTML = `${successfulParts.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${yieldPercent}%)</span>`;
            document.getElementById('lossDisplay').innerHTML = `${totalLossMass.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${lossPercent}%)</span>`;


            graphData.links = [
                { source: "Virgin material", target: "Print process", value: virginInput },
                { source: "Recycled pellets|(input)", target: "Print process", value: recycledInput },
                { source: "Print process", target: "Printed actuator", value: toPart },
                { source: "Print process", target: "Print loss", value: printLoss },
                { source: "Printed actuator", target: "Successful product", value: successfulParts },
                { source: "Printed actuator", target: "Failed parts", value: failedParts },
                { source: "Failed parts", target: "Shredder", value: failedParts },
                { source: "Shredder", target: "Recycled pellets|(output)", value: recycledPelletsOutput },
                { source: "Shredder", target: "Recycling loss", value: recyclingLoss }
            ];

            const filteredData = {
                nodes: graphData.nodes.map(node => ({ ...node })),
                links: graphData.links.filter(link => link.value > 0.001)
            };

            filteredData.nodes.forEach(node => {
                const incoming = filteredData.links.filter(l => l.target.name === node.name).reduce((sum, l) => sum + l.value, 0);
                const outgoing = filteredData.links.filter(l => l.source.name === node.name).reduce((sum, l) => sum + l.value, 0);
                node.value = Math.max(incoming, outgoing);
            });


            drawSankey(filteredData, totalMass, massUnit);
        }

        // --- Edge Case Detection ---
        function checkEdgeCases(params) {
            const { successRate, printLossRate, recyclingLossRate } = params;

            if (successRate === 0 && printLossRate === 0 && recyclingLossRate === 0) {
                showModal("Perfectly circular system", "With no material leaving the system as product or loss, it becomes self-sustaining. It can run on 100% recycled material, requiring no new virgin input.");
                return true;
            }

            if (successRate === 100) {
                showModal("Perfectly linear system", "All material successfully becomes product and exits the system. Since nothing is available for recycling, 100% of the input must be virgin material.");
                return true;
            }

            if (printLossRate === 100 || (successRate === 0 && recyclingLossRate === 100)) {
                showModal("Total system failure", "All material is lost either during printing or recycling. With no material recovered, the system requires 100% virgin material just to replace these losses.");
                return true;
            }
            return false;
        }

        function showModal(title, text) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            document.getElementById('modal').classList.add('active');
        }

        function showValidationMessage(inputElement, message) {
            const tooltip = inputElement.nextElementSibling;
            tooltip.textContent = message;
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 2000);
        }

        // --- Event Listeners and Control Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            let experimentRuns = [];
            let experimentInitialMass = 0;

            const totalMassInput = document.getElementById('totalMass');
            const massUnitInput = document.getElementById('massUnit');
            const successRateSlider = document.getElementById('successRate');
            const successRateValueSpan = document.getElementById('successRateValue');
            const printLossSlider = document.getElementById('printLossRate');
            const printLossValueSpan = document.getElementById('printLossRateValue');
            const recyclingLossSlider = document.getElementById('recyclingLossRate');
            const recyclingLossValueSpan = document.getElementById('recyclingLossRateValue');
            const modal = document.getElementById('modal');
            const modalCloseBtn = document.getElementById('modal-close');
            const parameterCard = document.getElementById('parameter-card');
            const flipToLogBtn = document.getElementById('flip-to-log');
            const flipToSimBtn = document.getElementById('flip-to-sim');

            const expStep1 = document.getElementById('exp-step-1');
            const expStep2 = document.getElementById('exp-step-2');
            const expStep3 = document.getElementById('exp-step-3');

            const calcStep1 = document.getElementById('calc-step-1');
            const calcStep2 = document.getElementById('calc-step-2');
            const calcStep3 = document.getElementById('calc-step-3');
            const calcPrintLoss = document.getElementById('calc-print-loss');
            const calcFailedParts = document.getElementById('calc-failed-parts');
            const calcRecyclingLoss = document.getElementById('calc-recycling-loss');

            const experimentInputs = [
                document.getElementById('printedActuatorMass'),
                document.getElementById('successfulProductMass'),
                document.getElementById('recycledPelletsOutputMass')
            ];

            const allNumericInputs = [totalMassInput, ...experimentInputs];

            const logRunBtn = document.getElementById('log-run-btn');
            const logRunContainer = document.getElementById('log-run-container');
            const experimentDataPanel = document.getElementById('experiment-data-panel');
            const experimentRunsBody = document.getElementById('experiment-runs-body');
            const experimentAvgFooter = document.getElementById('experiment-avg-footer');
            const applyAvgBtn = document.getElementById('apply-avg-btn');
            const applyAvgContainer = document.getElementById('apply-avg-container');
            const logInitialMassSpan = document.getElementById('log-initial-mass');
            const toggleDataPanelBtn = document.getElementById('toggle-data-panel');
            const dataTableContent = document.getElementById('data-table-content');
            const collapseIcon = document.getElementById('collapse-icon');
            const clearRunsBtn = document.getElementById('clear-runs-btn');
            const resultsDashboard = document.getElementById('results-dashboard');
            const exportCsvBtn = document.getElementById('export-csv-btn');


            function getParams() {
                return {
                    totalMass: parseFloat(totalMassInput.value) || 0,
                    massUnit: massUnitInput.value || 'units',
                    successRate: parseFloat(successRateSlider.value),
                    printLossRate: parseFloat(printLossSlider.value),
                    recyclingLossRate: parseFloat(recyclingLossSlider.value)
                };
            }

            function calculateFromExperiment() {
                const initialMass = parseFloat(totalMassInput.value) || 0;
                const printedMass = parseFloat(experimentInputs[0].value);
                const successfulMass = parseFloat(experimentInputs[1].value);
                const recycledMass = parseFloat(experimentInputs[2].value);
                const massUnit = massUnitInput.value || 'units';

                if (initialMass <= 0) return;

                let printLossRate = 0;
                let successRate = 0;
                let recyclingLossRate = 0;

                if (isNaN(printedMass)) {
                    // Reset steps 2 and 3 if step 1 is cleared
                    expStep2.classList.add('hidden');
                    expStep3.classList.add('hidden');
                    calcStep1.classList.add('hidden');
                    calcStep2.classList.add('hidden');
                    calcStep3.classList.add('hidden');
                    logRunContainer.classList.add('hidden');
                } else {
                    if (printedMass > initialMass) {
                        showModal("Input Error", "The 'Printed actuator mass' cannot be greater than the 'Initial input mass'.");
                        experimentInputs[0].value = '';
                        return;
                    }
                    const printLoss = initialMass - printedMass;
                    calcPrintLoss.textContent = `${printLoss.toFixed(1)} ${massUnit}`;
                    calcStep1.classList.remove('hidden');
                    printLossRate = initialMass > 0 ? (printLoss / initialMass * 100) : 0;
                    expStep2.classList.remove('hidden');
                }

                if (isNaN(successfulMass)) {
                    expStep3.classList.add('hidden');
                    calcStep2.classList.add('hidden');
                    calcStep3.classList.add('hidden');
                    logRunContainer.classList.add('hidden');
                } else if (!isNaN(printedMass)) {
                    if (successfulMass > printedMass) {
                        showModal("Input Error", "The 'Successful product mass' cannot be greater than the 'Printed actuator mass'.");
                        experimentInputs[1].value = '';
                        return;
                    }
                    const failedMass = printedMass - successfulMass;
                    calcFailedParts.textContent = `${failedMass.toFixed(1)} ${massUnit}`;
                    calcStep2.classList.remove('hidden');
                    successRate = printedMass > 0 ? (successfulMass / printedMass * 100) : 0;
                    expStep3.classList.remove('hidden');
                }

                if (isNaN(recycledMass)) {
                    calcStep3.classList.add('hidden');
                    logRunContainer.classList.add('hidden');
                } else if (!isNaN(printedMass) && !isNaN(successfulMass)) {
                    const failedMass = printedMass - successfulMass;
                    if (recycledMass > failedMass) {
                        showModal("Input Error", "The 'Recycled pellets mass' cannot be greater than the mass of failed parts.");
                        experimentInputs[2].value = '';
                        return;
                    }
                    const recyclingLoss = failedMass - recycledMass;
                    calcRecyclingLoss.textContent = `${recyclingLoss.toFixed(1)} ${massUnit}`;
                    calcStep3.classList.remove('hidden');
                    recyclingLossRate = failedMass > 0 ? (recyclingLoss / failedMass * 100) : 0;
                    logRunContainer.classList.remove('hidden');
                }

                // Update sliders
                successRateSlider.value = successRate;
                successRateValueSpan.textContent = `${successRate.toFixed(1)}%`;
                printLossSlider.value = printLossRate;
                printLossValueSpan.textContent = `${printLossRate.toFixed(1)}%`;
                recyclingLossSlider.value = recyclingLossRate;
                recyclingLossValueSpan.textContent = `${recyclingLossRate.toFixed(1)}%`;

                calculateAndDraw(getParams());

                const allInputsFilled = experimentInputs.every(input => input.value !== '');
                if (allInputsFilled) {
                    checkEdgeCases(getParams());
                }
            }

            function setupSlider(slider, valueSpan) {
                slider.addEventListener('input', (event) => {
                    const value = parseFloat(event.target.value);
                    valueSpan.textContent = `${value.toFixed(1)}%`;
                    experimentInputs.forEach(input => input.value = '');
                    expStep2.classList.add('hidden');
                    expStep3.classList.add('hidden');
                    calcStep1.classList.add('hidden');
                    calcStep2.classList.add('hidden');
                    calcStep3.classList.add('hidden');
                    logRunContainer.classList.add('hidden');
                    const params = getParams();
                    calculateAndDraw(params);
                    checkEdgeCases(params);
                });
            }

            setupSlider(successRateSlider, successRateValueSpan);
            setupSlider(printLossSlider, printLossValueSpan);
            setupSlider(recyclingLossSlider, recyclingLossValueSpan);

            allNumericInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (parseFloat(input.value) < 0) {
                        showValidationMessage(input, "Positive numbers only");
                        input.value = 0;
                    }
                    if (parameterCard.classList.contains('is-flipped')) {
                        calculateFromExperiment();
                    } else {
                        calculateAndDraw(getParams());
                    }
                });
            });

            massUnitInput.addEventListener('input', () => calculateAndDraw(getParams()));

            experimentInputs.forEach(input => {
                input.addEventListener('input', calculateFromExperiment);
            });

            flipToLogBtn.addEventListener('click', () => {
                parameterCard.classList.add('is-flipped');
                resultsDashboard.classList.add('hidden');
                if (experimentRuns.length > 0) {
                    dataTableContent.classList.remove('hidden');
                }
            });
            flipToSimBtn.addEventListener('click', () => {
                parameterCard.classList.remove('is-flipped');
                resultsDashboard.classList.remove('hidden');
                experimentInputs.forEach(input => input.value = '');
                expStep2.classList.add('hidden');
                expStep3.classList.add('hidden');
                calcStep1.classList.add('hidden');
                calcStep2.classList.add('hidden');
                calcStep3.classList.add('hidden');
                logRunContainer.classList.add('hidden');
                if (experimentRuns.length > 0) {
                    dataTableContent.classList.add('hidden');
                }
            });

            modalCloseBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // --- Experiment Log Table Logic ---
            logRunBtn.addEventListener('click', () => {
                const initialMass = parseFloat(totalMassInput.value);
                const massUnit = massUnitInput.value || 'units';

                if (experimentRuns.length > 0 && initialMass !== experimentInitialMass) {
                    showModal("Experiment Mismatch", "The 'Initial input mass' has changed. Please clear the existing logs to start a new set of experiments.");
                    return;
                }

                experimentInitialMass = initialMass;
                logInitialMassSpan.textContent = `${initialMass.toFixed(1)} ${massUnit}`;

                const newRun = {
                    printed: parseFloat(experimentInputs[0].value),
                    successful: parseFloat(experimentInputs[1].value),
                    recycled: parseFloat(experimentInputs[2].value)
                };
                experimentRuns.push(newRun);
                saveRunsToStorage();
                renderExperimentTable();

                experimentInputs.forEach(input => input.value = '');
                expStep2.classList.add('hidden');
                expStep3.classList.add('hidden');
                calcStep1.classList.add('hidden');
                calcStep2.classList.add('hidden');
                calcStep3.classList.add('hidden');
                logRunContainer.classList.add('hidden');
            });

            function renderExperimentTable() {
                experimentDataPanel.classList.remove('hidden');
                experimentRunsBody.innerHTML = '';
                const massUnit = massUnitInput.value || 'units';

                experimentRuns.forEach((run, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${index + 1}</td>
                        <td class="p-2">${run.printed.toFixed(1)} ${massUnit}</td>
                        <td class="p-2">${run.successful.toFixed(1)} ${massUnit}</td>
                        <td class="p-2">${run.recycled.toFixed(1)} ${massUnit}</td>
                        <td class="p-2">
                            <button data-index="${index}" class="apply-run-btn text-blue-500 hover:underline text-xs mr-2">Apply</button>
                            <button data-index="${index}" class="delete-run-btn text-red-500 hover:underline text-xs">Delete</button>
                        </td>
                    `;
                    experimentRunsBody.appendChild(row);
                });

                // Add event listeners
                experimentRunsBody.querySelectorAll('.delete-run-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        experimentRuns.splice(index, 1);
                        saveRunsToStorage();
                        renderExperimentTable();
                    });
                });
                experimentRunsBody.querySelectorAll('.apply-run-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const run = experimentRuns[index];
                        experimentInputs[0].value = run.printed;
                        experimentInputs[1].value = run.successful;
                        experimentInputs[2].value = run.recycled;
                        calculateFromExperiment();
                    });
                });

                calculateAndRenderAverages();
            }

            function calculateAndRenderAverages() {
                if (experimentRuns.length === 0) {
                    experimentDataPanel.classList.add('hidden');
                    return;
                }
                const massUnit = massUnitInput.value || 'units';
                const avgPrinted = experimentRuns.reduce((sum, run) => sum + run.printed, 0) / experimentRuns.length;
                const avgSuccessful = experimentRuns.reduce((sum, run) => sum + run.successful, 0) / experimentRuns.length;
                const avgRecycled = experimentRuns.reduce((sum, run) => sum + run.recycled, 0) / experimentRuns.length;

                experimentAvgFooter.innerHTML = `
                    <tr>
                        <td class="p-2">Avg</td>
                        <td class="p-2">${avgPrinted.toFixed(1)} ${massUnit}</td>
                        <td class="p-2">${avgSuccessful.toFixed(1)} ${massUnit}</td>
                        <td class="p-2">${avgRecycled.toFixed(1)} ${massUnit}</td>
                        <td class="p-2"></td>
                    </tr>
                `;
                applyAvgContainer.classList.remove('hidden');
            }

            applyAvgBtn.addEventListener('click', () => {
                const avgPrinted = experimentRuns.reduce((sum, run) => sum + run.printed, 0) / experimentRuns.length;
                const avgSuccessful = experimentRuns.reduce((sum, run) => sum + run.successful, 0) / experimentRuns.length;
                const avgRecycled = experimentRuns.reduce((sum, run) => sum + run.recycled, 0) / experimentRuns.length;

                // Temporarily set the experiment inputs to the averages to run the calculation
                experimentInputs[0].value = avgPrinted;
                experimentInputs[1].value = avgSuccessful;
                experimentInputs[2].value = avgRecycled;

                calculateFromExperiment();
            });

            exportCsvBtn.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Run #,Initial Mass,Unit,Printed Actuator,Successful Product,Recycled Pellets\n";

                experimentRuns.forEach((run, index) => {
                    const row = [
                        index + 1,
                        experimentInitialMass.toFixed(1),
                        massUnitInput.value,
                        run.printed.toFixed(1),
                        run.successful.toFixed(1),
                        run.recycled.toFixed(1)
                    ].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "experiment_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            toggleDataPanelBtn.addEventListener('click', () => {
                const isCollapsed = dataTableContent.classList.toggle('hidden');
                collapseIcon.innerHTML = isCollapsed ?
                    `<path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>` :
                    `<path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>`;
            });

            clearRunsBtn.addEventListener('click', () => {
                experimentRuns = [];
                saveRunsToStorage();
                renderExperimentTable();
            });

            function saveRunsToStorage() {
                localStorage.setItem('experimentRuns', JSON.stringify(experimentRuns));
                localStorage.setItem('experimentInitialMass', experimentInitialMass);
            }

            function loadRunsFromStorage() {
                const savedRuns = localStorage.getItem('experimentRuns');
                if (savedRuns) {
                    experimentRuns = JSON.parse(savedRuns);
                    experimentInitialMass = parseFloat(localStorage.getItem('experimentInitialMass')) || 0;
                    if (experimentRuns.length > 0) {
                        totalMassInput.value = experimentInitialMass.toFixed(1);
                        logInitialMassSpan.textContent = `${experimentInitialMass.toFixed(1)} ${massUnitInput.value}`;
                        renderExperimentTable();
                    }
                }
            }

            loadRunsFromStorage();
            calculateAndDraw(getParams());
            window.addEventListener('resize', () => calculateAndDraw(getParams()));
        });
    </script>
</body>

</html>