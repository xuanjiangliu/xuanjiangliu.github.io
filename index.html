<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Flow Sankey Diagram</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
        }

        .link {
            fill: none;
            stroke-opacity: 0.5;
        }

        .link:hover {
            stroke-opacity: 0.8;
        }

        .node text {
            pointer-events: none;
        }

        .sankey-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font-size: 14px;
            background: #1f2937;
            color: #ffffff;
            border: 0;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Flip card styles */
        .flip-card {
            perspective: 1000px;
        }

        .dashboard-panel {
            min-height: 280px;
            /* Ensures consistent height */
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            /* Match parent */
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        .validation-tooltip {
            position: absolute;
            background-color: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-gray-50">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Material flow analysis</h1>

            <p class="text-gray-600 mb-4">
                This interactive tool is designed for Material Flow Analysis (MFA) of a manufacturing process that uses
                both virgin and recycled materials. It helps visualize how different factors influence material
                efficiency, waste generation, and the potential for a circular economy.
            </p>
            <div class="text-gray-600 mb-6 text-sm p-4 bg-gray-50 rounded-lg border">
                <h3 class="font-semibold text-base text-gray-700 mb-2">How to use this tool</h3>
                <ol class="list-decimal list-inside space-y-1">
                    <li><strong>Set initial mass:</strong> Start by entering the total mass and unit for your system.
                    </li>
                    <li><strong>Choose your mode:</strong> Use the "Simulation mode" (sliders) to predict outcomes, or
                        flip to the "Experiment log" to calculate efficiencies from measured weights.</li>
                    <li><strong>Analyze results:</strong> The panels below the diagram show the required inputs and the
                        final system yield.</li>
                    <li><strong>Explore the flow:</strong> The diagram displays values in your chosen unit. Hover over
                        any flow or process box for precise values.</li>
                </ol>
            </div>

            <!-- Top Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Initial Mass Input -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg lg:col-span-1 dashboard-panel">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Initial input mass</label>
                    <p class="text-xs text-gray-500 mb-4">Define the starting mass and unit for the simulation.</p>
                    <div class="flex items-center space-x-4 relative">
                        <div class="flex-grow">
                            <label for="totalMass" class="text-xs text-gray-600">Mass</label>
                            <input type="number" id="totalMass" value="100.0" step="0.1" min="0"
                                class="w-full mt-1 p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="validation-tooltip">Positive numbers only</div>
                        </div>
                        <div class="w-1/3">
                            <label for="massUnit" class="text-xs text-gray-600">Unit</label>
                            <input type="text" id="massUnit" value="g"
                                class="w-full mt-1 p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div id="unaccounted-mass-container" class="mt-4 hidden">
                        <label for="unaccountedMass" class="block text-xs font-medium text-gray-700">Unaccounted
                            mass</label>
                        <div id="unaccountedMass" class="w-full mt-1 p-2 text-sm bg-yellow-100 border rounded-md">0.0 g
                        </div>
                    </div>
                </div>

                <!-- Process Parameters / Experiment Log -->
                <div class="lg:col-span-2 flip-card dashboard-panel" id="parameter-card">
                    <div class="flip-card-inner">
                        <!-- Front: Sliders -->
                        <div class="p-4 bg-blue-50 border border-blue-200 flip-card-front">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 font-bold">Simulation
                                        mode</label>
                                    <p class="text-xs text-gray-500">Adjust sliders to predict outcomes.</p>
                                </div>
                                <button id="flip-to-log" class="p-2 rounded-full hover:bg-blue-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                        class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                        <path
                                            d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                                        <path fill-rule="evenodd"
                                            d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A4.5 4.5 0 0 0 8 3zM3.5 9A4.5 4.5 0 0 0 8 13c1.552 0-2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-4 mt-2">
                                <div>
                                    <label for="successRate" class="block text-sm font-medium text-gray-700">Part
                                        success rate (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="successRate" min="0" max="100" value="80" step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="successRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">80.0%</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="printLossRate" class="block text-sm font-medium text-gray-700">Print
                                        loss (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="printLossRate" min="0" max="100" value="10" step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="printLossRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">10.0%</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="recyclingLossRate"
                                        class="block text-sm font-medium text-gray-700">Recycling loss (%):</label>
                                    <div class="flex items-center mt-1">
                                        <input type="range" id="recyclingLossRate" min="0" max="100" value="10"
                                            step="0.1"
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="recyclingLossRateValue"
                                            class="ml-4 font-semibold text-blue-700 w-16 text-center">10.0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Back: Experiment Log -->
                        <div class="p-4 bg-blue-50 border border-blue-200 flip-card-back">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 font-bold">Experiment
                                        log</label>
                                    <p class="text-xs text-gray-500">Enter measured weights to calculate efficiencies.
                                    </p>
                                </div>
                                <button id="flip-to-sim" class="p-2 rounded-full hover:bg-blue-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                        class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                        <path
                                            d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                                        <path fill-rule="evenodd"
                                            d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A4.5 4.5 0 0 0 8 3zM3.5 9A4.5 4.5 0 0 0 8 13c1.552 0-2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-4 mt-2">
                                <div class="relative">
                                    <label for="printedActuatorMass"
                                        class="block text-sm font-medium text-gray-700">Printed actuator mass</label>
                                    <input type="number" id="printedActuatorMass" placeholder="e.g., 90.0" step="0.1"
                                        min="0"
                                        class="w-full mt-1 p-2 text-sm border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="validation-tooltip">Positive numbers only</div>
                                </div>
                                <div class="relative">
                                    <label for="successfulProductMass"
                                        class="block text-sm font-medium text-gray-700">Successful product mass</label>
                                    <input type="number" id="successfulProductMass" placeholder="e.g., 72.0" step="0.1"
                                        min="0"
                                        class="w-full mt-1 p-2 text-sm border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="validation-tooltip">Positive numbers only</div>
                                </div>
                                <div class="relative">
                                    <label for="recycledPelletsOutputMass"
                                        class="block text-sm font-medium text-gray-700">Recycled pellets (output)
                                        mass</label>
                                    <input type="number" id="recycledPelletsOutputMass" placeholder="e.g., 16.2"
                                        step="0.1" min="0"
                                        class="w-full mt-1 p-2 text-sm border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="validation-tooltip">Positive numbers only</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sankey-chart-container" class="w-full overflow-x-auto mt-6 mb-6">
                <svg id="sankey"></svg>
            </div>

            <!-- Bottom Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Material Composition Display -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Required input
                        composition</label>
                    <p class="text-xs text-gray-500 mb-4">The calculated material mix needed to sustain the process
                        based on losses.</p>
                    <div class="flex items-center space-x-4 text-center">
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Virgin material</div>
                            <div id="virginRateDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Recycled pellets</div>
                            <div id="recycledRateDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Overall System Yield Display -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2 font-bold">Overall system yield</label>
                    <p class="text-xs text-gray-500 mb-4">The final percentage of material that becomes successful
                        product vs. total loss.</p>
                    <div class="flex items-center space-x-4 text-center">
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Successful product</div>
                            <div id="yieldDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-600">Total system loss</div>
                            <div id="lossDisplay" class="text-lg font-bold text-gray-800 mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sankey-tooltip"></div>
        </div>
    </div>

    <!-- Modal for Edge Case Explanations -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Edge case detected</h3>
            <p id="modal-text" class="text-gray-600 mb-5">Explanation of the scenario.</p>
            <button id="modal-close"
                class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Close</button>
        </div>
    </div>

    <script>
        // --- Data Processing and Initial Setup ---
        const graphData = {
            nodes: [
                { name: "Virgin material", color: "#647687" },
                { name: "Recycled pellets|(input)", color: "#22c55e" },
                { name: "Print process", color: "#f8cecc" },
                { name: "Printed actuator", color: "#dae8fc" },
                { name: "Successful product", color: "#e6f7ff" },
                { name: "Failed parts", color: "#ffe6cc" },
                { name: "Shredder", color: "#76608a" },
                { name: "Print loss", color: "#d6d6d6" },
                { name: "Recycling loss", color: "#d6d6d6" },
                { name: "Recycled pellets|(output)", color: "#22c55e" }
            ],
            links: [] // Links are calculated dynamically
        };

        // --- D3 Sankey Drawing Function ---
        function drawSankey(data, totalMass, massUnit) {
            const container = d3.select("#sankey-chart-container");
            container.select("svg").selectAll("*").remove();

            const containerWidth = parseInt(container.style("width"));
            const height = 500;
            const width = Math.max(containerWidth, 900);

            const svg = d3.select("#sankey")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMinYMin meet");

            // --- Dynamic Node Width Calculation ---
            let maxTextWidth = 0;
            const tempText = svg.append("text")
                .attr("font-family", "Inter, sans-serif")
                .attr("font-size", "12px")
                .attr("font-weight", "bold");

            data.nodes.forEach(node => {
                if (node.value > 0.01) {
                    const text = `${node.value.toFixed(1)} ${massUnit}`;
                    maxTextWidth = Math.max(maxTextWidth, tempText.text(text).node().getComputedTextLength());
                }
            });
            tempText.remove();
            const dynamicNodeWidth = Math.max(60, maxTextWidth + 10);

            const sankey = d3.sankey()
                .nodeId(d => d.name)
                .nodeWidth(dynamicNodeWidth)
                .nodePadding(20)
                .nodeAlign(d3.sankeyJustify)
                .extent([[1, 5], [width - 1, height - 10]]);

            let layout;
            try {
                layout = sankey(data);
            } catch (error) {
                console.error("Error computing Sankey layout:", error);
                container.html(`<div class="text-red-600 p-4">Error: Could not generate the diagram.</div>`);
                return;
            }
            const { nodes, links } = layout;
            const tooltip = d3.select(".sankey-tooltip");

            // Draw Links
            const linkGroup = svg.append("g").attr("fill", "none").attr("stroke-opacity", 0.5);
            const link = linkGroup.selectAll("g").data(links).join("g").style("mix-blend-mode", "multiply");
            const gradient = link.append("linearGradient")
                .attr("id", (d, i) => `gradient-${i}`)
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", d => d.source.x1)
                .attr("x2", d => d.target.x0);
            gradient.append("stop").attr("offset", "0%").attr("stop-color", d => d.source.color);
            gradient.append("stop").attr("offset", "100%").attr("stop-color", d => d.target.color);
            link.append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width));

            link.on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${d.source.name.replace('|', ' ')} &rarr; ${d.target.name.replace('|', ' ')}<br><b>${d.value.toFixed(2)} ${massUnit}</b>`)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Draw Nodes
            const nodeGroup = svg.append("g").attr("class", "nodes");
            const node = nodeGroup.selectAll("g").data(nodes).join("g")
                .style("display", d => d.value < 0.01 ? "none" : "block");

            node.append("rect")
                .attr("x", d => d.x0).attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
                .attr("fill", d => d.color).attr("stroke", "#374151")
                .attr("stroke-width", 1.5).attr("rx", 4).attr("ry", 4);

            node.on("mouseover", (event, d) => {
                const percentage = totalMass > 0 ? (d.value / totalMass * 100).toFixed(1) : 0;
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${d.name.replace('|', ' ')}<br><b>${d.value.toFixed(1)} ${massUnit}</b><br><span class="text-xs">(${percentage}% of total)</span>`)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Add Node Labels (Name)
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .style("font-size", "13px")
                .style("font-weight", "600")
                .style("fill", "#374151")
                .each(function (d) {
                    const lines = d.name.split('|');
                    const textElement = d3.select(this);
                    const lineHeight = 1.2;
                    const startDy = -((lines.length - 1) / 2) * lineHeight;

                    lines.forEach((line, i) => {
                        textElement.append("tspan")
                            .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                            .attr("dy", i === 0 ? `${startDy}em` : `${lineHeight}em`)
                            .text(line);
                    });
                });

            // Add Node Value inside the box
            node.append("text")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => `${d.value.toFixed(1)} ${massUnit}`)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("fill", "#111827")
                .style("display", d => (d.y1 - d.y0) > 15 ? "block" : "none");

        }

        // --- Dynamic Calculation Function for Steady-State ---
        function calculateAndDraw(params) {
            const { successRate, printLossRate, recyclingLossRate, totalMass, massUnit } = params;

            const successDecimal = successRate / 100;
            const printLossDecimal = printLossRate / 100;
            const recyclingLossDecimal = recyclingLossRate / 100;

            const printLoss = totalMass * printLossDecimal;
            const toPart = totalMass * (1 - printLossDecimal);

            const successfulParts = toPart * successDecimal;
            const failedParts = toPart * (1 - successDecimal);

            const recyclingLoss = failedParts * recyclingLossDecimal;
            const recycledPelletsOutput = failedParts * (1 - recyclingLossDecimal);

            const recycledInput = recycledPelletsOutput;
            const virginInput = printLoss + recyclingLoss + successfulParts;
            const totalLoss = printLoss + recyclingLoss + (failedParts * (1 - (1 - recyclingLossDecimal)))

            // Update display boxes
            const virginPercent = totalMass > 0 ? (virginInput / totalMass * 100).toFixed(1) : 0;
            const recycledPercent = totalMass > 0 ? (recycledInput / totalMass * 100).toFixed(1) : 0;
            document.getElementById('virginRateDisplay').innerHTML = `${virginInput.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${virginPercent}%)</span>`;
            document.getElementById('recycledRateDisplay').innerHTML = `${recycledInput.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${recycledPercent}%)</span>`;

            const yieldPercent = totalMass > 0 ? (successfulParts / totalMass * 100).toFixed(1) : 0;
            const totalLossMass = totalMass - successfulParts;
            const lossPercent = totalMass > 0 ? (totalLossMass / totalMass * 100).toFixed(1) : 0;
            document.getElementById('yieldDisplay').innerHTML = `${successfulParts.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${yieldPercent}%)</span>`;
            document.getElementById('lossDisplay').innerHTML = `${totalLossMass.toFixed(1)} ${massUnit} <span class="text-sm text-gray-500">(${lossPercent}%)</span>`;


            graphData.links = [
                { source: "Virgin material", target: "Print process", value: virginInput },
                { source: "Recycled pellets|(input)", target: "Print process", value: recycledInput },
                { source: "Print process", target: "Printed actuator", value: toPart },
                { source: "Print process", target: "Print loss", value: printLoss },
                { source: "Printed actuator", target: "Successful product", value: successfulParts },
                { source: "Printed actuator", target: "Failed parts", value: failedParts },
                { source: "Failed parts", target: "Shredder", value: failedParts },
                { source: "Shredder", target: "Recycled pellets|(output)", value: recycledPelletsOutput },
                { source: "Shredder", target: "Recycling loss", value: recyclingLoss }
            ];

            const filteredData = {
                nodes: graphData.nodes.map(node => ({ ...node })),
                links: graphData.links.filter(link => link.value > 0.001)
            };

            filteredData.nodes.forEach(node => {
                const incoming = filteredData.links.filter(l => l.target.name === node.name).reduce((sum, l) => sum + l.value, 0);
                const outgoing = filteredData.links.filter(l => l.source.name === node.name).reduce((sum, l) => sum + l.value, 0);
                node.value = Math.max(incoming, outgoing);
            });


            drawSankey(filteredData, totalMass, massUnit);
        }

        // --- Edge Case Detection ---
        function checkEdgeCases(params) {
            const { successRate, printLossRate, recyclingLossRate } = params;

            if (successRate === 0 && printLossRate === 0 && recyclingLossRate === 0) {
                showModal("Perfectly circular system", "With no material leaving the system as product or loss, it becomes self-sustaining. It can run on 100% recycled material, requiring no new virgin input.");
                return true;
            }

            if (successRate === 100) {
                showModal("Perfectly linear system", "All material successfully becomes product and exits the system. Since nothing is available for recycling, 100% of the input must be virgin material.");
                return true;
            }

            if (printLossRate === 100 || (successRate === 0 && recyclingLossRate === 100)) {
                showModal("Total system failure", "All material is lost either during printing or recycling. With no material recovered, the system requires 100% virgin material just to replace these losses.");
                return true;
            }
            return false;
        }

        function showModal(title, text) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            document.getElementById('modal').classList.add('active');
        }

        function showValidationMessage(inputElement, message) {
            const tooltip = inputElement.nextElementSibling;
            tooltip.textContent = message;
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 2000);
        }

        // --- Event Listeners and Control Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const totalMassInput = document.getElementById('totalMass');
            const massUnitInput = document.getElementById('massUnit');
            const successRateSlider = document.getElementById('successRate');
            const successRateValueSpan = document.getElementById('successRateValue');
            const printLossSlider = document.getElementById('printLossRate');
            const printLossValueSpan = document.getElementById('printLossRateValue');
            const recyclingLossSlider = document.getElementById('recyclingLossRate');
            const recyclingLossValueSpan = document.getElementById('recyclingLossRateValue');
            const modal = document.getElementById('modal');
            const modalCloseBtn = document.getElementById('modal-close');
            const parameterCard = document.getElementById('parameter-card');
            const flipToLogBtn = document.getElementById('flip-to-log');
            const flipToSimBtn = document.getElementById('flip-to-sim');
            const unaccountedMassContainer = document.getElementById('unaccounted-mass-container');
            const unaccountedMassDisplay = document.getElementById('unaccountedMass');

            const experimentInputs = [
                document.getElementById('printedActuatorMass'),
                document.getElementById('successfulProductMass'),
                document.getElementById('recycledPelletsOutputMass')
            ];

            const allNumericInputs = [totalMassInput, ...experimentInputs];

            function getParams() {
                return {
                    totalMass: parseFloat(totalMassInput.value) || 0,
                    massUnit: massUnitInput.value || 'units',
                    successRate: parseFloat(successRateSlider.value),
                    printLossRate: parseFloat(printLossSlider.value),
                    recyclingLossRate: parseFloat(recyclingLossSlider.value)
                };
            }

            function calculateFromExperiment() {
                const initialMass = parseFloat(totalMassInput.value) || 0;
                const printedMass = parseFloat(experimentInputs[0].value) || 0;
                const successfulMass = parseFloat(experimentInputs[1].value) || 0;
                const recycledMass = parseFloat(experimentInputs[2].value) || 0;
                const massUnit = massUnitInput.value || 'units';

                unaccountedMassDisplay.textContent = `0.0 ${massUnit}`;

                if (initialMass <= 0) return;

                const unaccountedMass = (printedMass + successfulMass + recycledMass) - initialMass;

                if (printedMass > initialMass) {
                    showModal("Input Error", "The 'Printed actuator mass' cannot be greater than the 'Initial input mass'. Please check your numbers.");
                    return;
                }
                if (successfulMass > printedMass) {
                    showModal("Input Error", "The 'Successful product mass' cannot be greater than the 'Printed actuator mass'. Please check your numbers.");
                    return;
                }
                if (recycledMass > (printedMass - successfulMass)) {
                    showModal("Input Error", "The 'Recycled pellets mass' cannot be greater than the mass of failed parts. Please check your numbers.");
                    return;
                }


                // Calculate Print Loss
                const printLoss = initialMass - printedMass;
                const printLossRate = initialMass > 0 ? (printLoss / initialMass * 100) : 0;

                // Calculate Success Rate
                const successRate = printedMass > 0 ? (successfulMass / printedMass * 100) : 0;

                // Calculate Recycling Loss / Unaccounted Mass
                const failedMass = printedMass - successfulMass;
                const recyclingLoss = failedMass - recycledMass;
                unaccountedMassDisplay.textContent = `${recyclingLoss.toFixed(1)} ${massUnit}`;

                const recyclingLossRate = failedMass > 0 ? (recyclingLoss / failedMass * 100) : 0;

                // Update sliders
                successRateSlider.value = successRate;
                successRateValueSpan.textContent = `${successRate.toFixed(1)}%`;
                printLossSlider.value = printLossRate;
                printLossValueSpan.textContent = `${printLossRate.toFixed(1)}%`;
                recyclingLossSlider.value = recyclingLossRate;
                recyclingLossValueSpan.textContent = `${recyclingLossRate.toFixed(1)}%`;

                calculateAndDraw(getParams());

                const allInputsFilled = experimentInputs.every(input => input.value !== '');
                if (allInputsFilled && Math.abs(recyclingLoss) < 0.01) {
                    checkEdgeCases(getParams());
                }
            }

            function setupSlider(slider, valueSpan) {
                slider.addEventListener('input', (event) => {
                    const value = parseFloat(event.target.value);
                    valueSpan.textContent = `${value.toFixed(1)}%`;
                    experimentInputs.forEach(input => input.value = '');
                    unaccountedMassContainer.classList.add('hidden');
                    const params = getParams();
                    calculateAndDraw(params);
                    checkEdgeCases(params);
                });
            }

            setupSlider(successRateSlider, successRateValueSpan);
            setupSlider(printLossSlider, printLossValueSpan);
            setupSlider(recyclingLossSlider, recyclingLossValueSpan);

            allNumericInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (parseFloat(input.value) < 0) {
                        showValidationMessage(input, "Positive numbers only");
                        input.value = 0;
                    }
                    if (parameterCard.classList.contains('is-flipped')) {
                        calculateFromExperiment();
                    } else {
                        calculateAndDraw(getParams());
                    }
                });
            });

            massUnitInput.addEventListener('input', () => calculateAndDraw(getParams()));

            experimentInputs.forEach(input => {
                input.addEventListener('input', calculateFromExperiment);
            });

            flipToLogBtn.addEventListener('click', () => {
                parameterCard.classList.add('is-flipped');
                unaccountedMassContainer.classList.remove('hidden');
            });
            flipToSimBtn.addEventListener('click', () => {
                parameterCard.classList.remove('is-flipped');
                unaccountedMassContainer.classList.add('hidden');
            });

            modalCloseBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });

            calculateAndDraw(getParams());
            window.addEventListener('resize', () => calculateAndDraw(getParams()));
        });
    </script>
</body>

</html>